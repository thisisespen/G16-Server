---
Dokument: G16 Server – Autoritativ systeminstruks  
Versjon: 1.1  
Sist endret: 2026.01.10 kl.09.45  
Status: Gjeldende fasit  
Eier: Espen Birkeland  
Prosjekt: G16 Server  
Format: Markdown (GitHub / Obsidian / Notion)  
---

# G16 Server – Autoritativ systeminstruks

## 0. Bruksregel og instruks til assistent (OBLIGATORISK)

Dette dokumentet er **autorativ systeminstruks** for G16 Server-prosjektet.

Dokumentet fungerer samtidig som:
- arkitekturstandard
- kravspesifikasjon
- rekonstruksjonsinstruks
- instruks til ChatGPT / assistent
- grunnlag for endringskontroll

### 0.1 Instruks til assistent (ChatGPT)

Ved bistand i G16 Server-prosjektet **SKAL** assistenten:

1. Behandle dette dokumentet som **fasit**
2. Følge arkitektur, krav og prinsipper beskrevet her
3. Arbeide **stegvis**, med én konkret handling om gangen
4. **Aldri anta** at handlinger er utført uten eksplisitt bekreftelse
5. Stoppe og be om avklaring ved:
   - avvik fra dokumentet
   - behov for unntak
   - manglende informasjon
6. Ikke foreslå alternative arkitekturer, verktøy eller snarveier
   uten eksplisitt forespørsel fra eier

Alle nye installasjoner, endringer eller vurderinger **SKAL vurderes opp mot dette dokumentet**.  
Dersom noe ikke kan etterleve kravene her, **SKAL dokumentet endres før teknisk implementasjon**.

### 0.1.1 Regel for oppdatering og deling av autorativ dokumentasjon

Når den autorative systeminstruksen oppdateres, redigeres eller videreformidles
(slik som ved arbeid i GitHub), **SKAL dokumentet alltid gis i sin helhet**,
med mindre noe annet er eksplisitt forespurt.

Delvis gjengivelse av dokumentet **ER IKKE TILLATT** som standard.

#### Begrunnelse

- Delvis gjengivelse har tidligere ført til:
  - manglende kapitler
  - usynkronisert innholdsfortegnelse
  - tap av kontekst og styrende prinsipper
- Dokumentet fungerer samtidig som:
  - arkitekturstandard
  - kravspesifikasjon
  - rekonstruksjonsinstruks
- Fragmentering bryter dokumentets rolle som autorativ fasit

Unntak fra denne regelen **SKAL** være eksplisitt forespurt og tydelig avgrenset.

### 0.2 Bruk av dokumentet i praksis

- Lagring:
  - GitHub (versjonskontroll)
  - Notion / Obsidian (arbeidsflate)
- Ved ny ChatGPT-sesjon:
  - Dokumentet **limes inn eller refereres eksplisitt**
- Ved reinstallasjon:
  - Dokumentet brukes som **rekonstruksjonsinstruks**
- Ved ny app / tjeneste:
  - Dokumentet er **kravgrunnlag**
  - Appen tilpasses dokumentet – ikke motsatt

### 0.3 Regel for struktur, anker-ID og kryssreferanser

- Alle hovedkapitler (`##`) **SKAL** ha eksplisitt anker-ID
- Underkapitler **SKAL** ha anker-ID dersom de refereres
- Kryssreferanser **SKAL** bruke eksplisitte anker-IDer
- Auto-genererte overskriftslenker **SKAL IKKE** brukes

Anker-IDer anses som **kontrakter**. Endringer **SKAL** loggføres.

---

## Innholdsfortegnelse

1. Formål og designprinsipper  
2. Overordnet arkitektur og rolleforståelse  
3. TrueNAS SCALE – grunnleggende driftskrav  
4. Docker – kravspesifikasjon for alle apper  
5. Docker Compose – standard og praksis  
6. Lagring, snapshots og backup-strategi  
7. Varsling og overvåkning  
8. Rekonstruksjon fra blank installasjon  
9. Endringskontroll og videreutvikling  
10. Omfang, bevisste avgrensninger og utelatelser  
11. Endringslogg (Changelog)  
Vedlegg A – Sjekkliste for ny Docker-applikasjon  

---

<a id="formal"></a>
## 1. Formål og designprinsipper

### 1.1 Formål

G16 Server skal være en:
- stabil
- ryddig
- kontrollerbar
- gjenopprettbar

serverplattform for egne tjenester.

### 1.2 Designprinsipper (styrende)

- **Produksjon først**
- **Reproduserbarhet**
- **Ingen antagelser**
- **Minimal teknisk gjeld**
- **Tydelig eierskap**

---

<a id="arkitektur"></a>
## 2. Overordnet arkitektur og rolleforståelse

### 2.1 Arkitektur – oversiktsmodell

Lagdeling:
1. Maskinvare
2. TrueNAS SCALE
3. Docker
4. Brukertjenester

### 2.2 Rollefordeling (låst)

Ingen komponent **SKAL** overta ansvar fra annet lag.

### 2.3 Grenseflater mellom lagene

- TrueNAS ↔ Docker: datasets, volumes, nettverk
- Docker ↔ Bruker: reverse proxy, autentisering, porter

### 2.4 Arkitekturprinsipp: enkelhet før fleksibilitet

Kontroll og gjenopprettbarhet prioriteres.

### 2.5 Domene, DNS og eksponering av tjenester

#### 2.5.1 Domene og DNS (Cloudflare)
- Cloudflare er autorativ DNS
- Alle tjenester bruker subdomener

#### 2.5.2 DNS-navngivning (låst)
Kun ett-nivås subdomener tillatt.

#### 2.5.3 Cloudflare proxy
Alle subdomener **SKAL** proxys via Cloudflare.

#### 2.5.4 Landbasert tilgangskontroll (Cloudflare)

not ip.src.country in {"NO" "SE" "DK" "FI" "DE" "NL" "IE"}

yaml
Kopier kode

- Action: Block  
- Order: First  
- Status: Verifisert i drift  

#### 2.5.5 Nettverk og porter
- Kun 443/TCP åpen
- Ingen direkte app-porter

#### 2.5.6 Ingress og tilgangskontroll
- Traefik er eneste ingress
- Authentik er sentral portvakt

#### 2.5.7 Unntak – Plex
Ikke proxied via Cloudflare.

#### 2.5.8 Unntak – Torrent-klient
Definert portområde tillatt.

---

<a id="truenas-krav"></a>
## 3. TrueNAS SCALE – grunnleggende driftskrav

### 3.1 Rolleforståelse
TrueNAS behandles som appliance.

### 3.2 Endringer
Ingen manuell OS-pakkeinstallasjon.

### 3.3 Brukere og rettigheter
Least privilege på dataset-nivå.

### 3.4 Dataset-struktur
Ingen data i pool-root.

### 3.5 Oppdateringer
Kun med fungerende backup.

### 3.6 Logging og verifikasjon
Status skal alltid kunne verifiseres.

---

<a id="docker-krav"></a>
## 4. Docker – kravspesifikasjon for alle apper

- Kun Docker Compose
- Én app = én mappe
- Ingen `docker run` i produksjon
- Gjenopprettbarhet er krav

---

<a id="docker-compose-standard"></a>
## 5. Docker Compose – standard og praksis

### 5.1 Standard mappestruktur

```text
/app/
 ├─ docker-compose.yml
 ├─ .env
 ├─ data/
 ├─ db/
 └─ redis/
5.2 Nettverk
Eksternt Docker-nettverk: proxy

Internt nettverk: ett bridge-nettverk per stack

Kun applikasjonscontainer på proxy

5.3 Traefik
traefik.enable=true

traefik.docker.network=proxy

Routere SKAL bindes eksplisitt til service

5.4 Authentik
Middleware SKAL refereres som authentik@file

authentik@docker SKAL IKKE brukes

5.5 Healthchecks
Healthchecks er obligatorisk for web-tjenester.

<a id="backup-strategi"></a>

6. Lagring, snapshots og backup-strategi
Snapshots på dataset-nivå

ZFS-replikering

Backup-nivå A: USB-SSD

Backup-nivå B: Offline USB-HDD

TrueNAS config-backup separat

<a id="varsling"></a>

7. Varsling og overvåkning
Primær kanal: e-post

Systemkonto: grevlingstien16@gmail.com

Kun kritiske hendelser

<a id="rekonstruksjon"></a>

8. Rekonstruksjon fra blank installasjon
8.1 Formål og forutsetninger
Rekonstruksjon skal kunne gjøres uten improvisasjon.

8.2 Overordnet rekkefølge
Installer TrueNAS SCALE

Importer systemkonfigurasjon

Importer datapooler

Verifiser backup og varsling

Start Docker-apper

<a id="endringskontroll"></a>

9. Endringskontroll og videreutvikling
Dokumentet leder systemet – ikke omvendt.

<a id="omfang"></a>

10. Omfang og avgrensninger
Dokumentet dekker arkitektur og krav – ikke klikk-for-klikk guider.

<a id="endringslogg-changelog"></a>

11. Endringslogg (Changelog)
2026.01.10 kl.09.45 – Versjon 1.1
Rettet formateringsfeil i kapittel 5 (kodeblokk avsluttet korrekt)

Ingen endring i innhold, krav eller arkitektur
